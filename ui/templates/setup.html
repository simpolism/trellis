{% extends "base.html" %}

{% block title %}Trellis - Setup{% endblock %}

{% block content %}
<h2>Trellis Setup</h2>
<p><em>Configure your training session and start steering.</em></p>

<hr>

<!-- Session Resume Section -->
<div class="card">
    <h3>Quick Resume</h3>
    <p><em>Continue a previous training session. Sessions are automatically saved after each preference selection.</em></p>

    {% if sessions %}
    <div class="form-group">
        <label for="session-select">Existing Sessions</label>
        <select id="session-select" name="session_select">
            <option value="">-- Select a session --</option>
            {% for display_name, path in sessions %}
            <option value="{{ path }}">{{ display_name }}</option>
            {% endfor %}
        </select>
        <div class="info-text">Select a saved session to resume</div>
    </div>

    <button class="primary" onclick="resumeSession()">
        Resume Session Now
    </button>
    <button class="secondary" onclick="cloneSettings()">
        Clone Settings
    </button>
    {% else %}
    <p><em>No existing sessions found. Start a new session below.</em></p>
    {% endif %}

    <div id="resume-status" style="margin-top: 8px;"></div>

    <script>
    function cloneSettings() {
        const sessionSelect = document.getElementById('session-select');
        const sessionPath = sessionSelect.value;

        if (!sessionPath) {
            document.getElementById('resume-status').innerHTML =
                '<p style="color: var(--danger);">Please select a session first</p>';
            return;
        }

        fetch(`/setup/session-config?session_path=${encodeURIComponent(sessionPath)}`)
        .then(response => response.json())
        .then(config => {
            if (config.error) {
                throw new Error(config.error);
            }
            
            // Populate fields
            document.getElementById('model-name').value = config.model_name || '';
            document.getElementById('context-length').value = config.max_seq_length || 4096;
            document.getElementById('group-size').value = config.group_size || 4;
            document.getElementById('learning-rate').value = config.learning_rate || 2e-5;
            document.getElementById('kl-beta').value = config.kl_beta || 0.03;
            document.getElementById('temperature').value = config.temperature || 1.2;
            document.getElementById('max-new-tokens').value = config.max_new_tokens || 256;
            document.getElementById('lora-rank').value = config.lora_rank || 16;
            document.getElementById('lora-alpha').value = config.lora_alpha || 16;
            document.getElementById('max-undos').value = config.max_undos || '';
            document.getElementById('checkpoint-interval').value = config.checkpoint_interval || 1;
            document.getElementById('system-prompt').value = config.system_prompt || '';
            document.getElementById('prompt-prefix').value = config.prompt_prefix || '';
            document.getElementById('prompt-suffix').value = config.prompt_suffix || '';
            document.getElementById('dataset-id').value = config.default_dataset || '';
            document.getElementById('control-prompt').value = config.control_prompt || '';
            
            // Checkboxes
            document.getElementById('append-think-tag').checked = config.append_think_tag !== false;
            document.getElementById('use-chat-template').checked = config.use_chat_template !== false;
            
            // Precision logic
            if (config.load_in_8bit) {
                document.getElementById('precision').value = "8-bit";
            } else if (config.load_in_4bit) {
                document.getElementById('precision').value = "4-bit";
            } else {
                document.getElementById('precision').value = "16-bit";
            }

            document.getElementById('resume-status').innerHTML = '<p style="color: var(--trellis-green);">âœ… Settings loaded!</p>';
            
            // Scroll down to review
            document.getElementById('model-name').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            document.getElementById('resume-status').innerHTML = 
                '<p style="color: var(--danger);">Error loading settings: ' + error.message + '</p>';
        });
    }

    function resumeSession() {
        const sessionSelect = document.getElementById('session-select');
        const sessionPath = sessionSelect.value;

        if (!sessionPath) {
            document.getElementById('resume-status').innerHTML =
                '<p style="color: var(--danger);">Please select a session first</p>';
            return;
        }

        const formData = new URLSearchParams();
        formData.append('session_select', sessionPath);

        const statusDiv = document.getElementById('resume-status');
        statusDiv.innerHTML = '<p><em>Resuming session...</em></p>';

        fetch('/setup/resume-session', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to resume session');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        return;
                    }

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            statusDiv.innerHTML += '<p>' + data + '</p>';
                        } else if (line.includes('event: redirect')) {
                            setTimeout(() => {
                                window.location.href = '/training';
                            }, 500);
                        }
                    });

                    readStream();
                });
            }

            readStream();
        })
        .catch(error => {
            statusDiv.innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
        });
    }
    </script>
</div>

<hr>

<!-- Dataset Section -->
<div class="card">
    <h3>Dataset</h3>
    <p><em>Choose the prompts that will be used to train your model.</em></p>

    <div class="form-group">
        <label for="dataset-id">Dataset ID</label>
        <input type="text"
               id="dataset-id"
               name="dataset_id"
               value="{{ default_dataset }}"
               placeholder="e.g., abhayesian/introspection-prompts">
        <div class="info-text">HuggingFace dataset ID or local folder path</div>
    </div>

    <div class="form-group">
        <label for="dataset-subset">Subset (optional)</label>
        <input type="text" id="dataset-subset" name="dataset_subset" placeholder="e.g., persona">
    </div>

    <div class="form-group">
        <label for="dataset-split">Split</label>
        <select id="dataset-split" name="dataset_split">
            <option value="train" selected>train</option>
            <option value="test">test</option>
            <option value="validation">validation</option>
        </select>
    </div>

    <div class="form-group">
        <label for="dataset-column">Text Column (auto-detected)</label>
        <input type="text" id="dataset-column" name="dataset_column" value="text" placeholder="Leave blank for auto">
        <div class="info-text">Column containing prompts (usually auto-detected)</div>
    </div>

    <button hx-post="/setup/preview-dataset"
            hx-include="#dataset-id, #dataset-subset, #dataset-split, #dataset-column"
            hx-target="#dataset-preview">
        Load & Preview Dataset
    </button>

    <div id="dataset-preview" style="margin-top: 16px;"></div>
</div>

<hr>

<!-- Model Section -->
<div class="card">
    <h3>Model</h3>
    <p><em>Select the base model to train.</em></p>

    <div class="form-group">
        <label for="model-name">Model Name</label>
        <input type="text"
               id="model-name"
               name="model_name"
               value="unsloth/gemma-3-1b-it-unsloth-bnb-4bit"
               placeholder="HuggingFace model ID or local path">
    </div>

    <div style="display: flex; gap: 16px;">
        <div class="form-group" style="flex: 2;">
            <label for="context-length">Context Length</label>
            <input type="number"
                   id="context-length"
                   name="context_length"
                   value="4096"
                   min="512"
                   max="8192"
                   step="256">
            <div class="info-text">Max tokens per prompt+response. Higher = more memory</div>
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="group-size">Options per Prompt</label>
            <input type="number"
                   id="group-size"
                   name="group_size"
                   value="4"
                   min="2"
                   max="8">
            <div class="info-text">How many response options to generate</div>
        </div>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox"
                   id="use-chat-template"
                   name="use_chat_template"
                   checked>
            Use Chat Template
        </label>
        <div class="info-text">Disable for base models (e.g., Trinity-Nano-Base)</div>
    </div>

    <button class="secondary" onclick="connectModelLoading()">Load Model</button>

    <div id="model-status" style="margin-top: 8px;"></div>

    <script>
    function connectModelLoading() {
        const modelName = document.getElementById('model-name').value;
        const precision = document.getElementById('precision').value;
        const params = new URLSearchParams();
        params.set('model_name', modelName);
        params.set('context_length', document.getElementById('context-length').value);
        params.set('group_size', document.getElementById('group-size').value);
        params.set('engine_name', document.getElementById('engine').value);
        params.set('learning_rate', document.getElementById('learning-rate').value);
        params.set('kl_beta', document.getElementById('kl-beta').value);
        params.set('temperature', document.getElementById('temperature').value);
        params.set('max_new_tokens', document.getElementById('max-new-tokens').value);
        params.set('lora_rank', document.getElementById('lora-rank').value);
        params.set('lora_alpha', document.getElementById('lora-alpha').value);
        const maxUndos = document.getElementById('max-undos').value;
        if (maxUndos) {
            params.set('max_undos', maxUndos);
        }
        params.set('system_prompt', document.getElementById('system-prompt').value || '');
        params.set('prompt_prefix', document.getElementById('prompt-prefix').value || '');
        params.set('prompt_suffix', document.getElementById('prompt-suffix').value || '');
        params.set('dataset_id', document.getElementById('dataset-id').value);
        params.set('precision', precision);
        params.set('append_think_tag', document.getElementById('append-think-tag').checked);
        params.set('use_chat_template', document.getElementById('use-chat-template').checked);
        params.set('control_prompt', document.getElementById('control-prompt').value || '');
        const url = `/setup/load-model?${params.toString()}`;

        const statusDiv = document.getElementById('model-status');
        statusDiv.innerHTML = '';
        const eventSource = new EventSource(url, { withCredentials: true });

        eventSource.addEventListener('message', (e) => {
            statusDiv.innerHTML += '<p>' + e.data + '</p>';
        });

        eventSource.addEventListener('complete', () => {
            eventSource.close();
        });

        eventSource.addEventListener('error', (e) => {
            if (e.data) {
                statusDiv.innerHTML += '<p style="color: var(--danger);">' + e.data + '</p>';
            }
            eventSource.close();
        });
    }
    </script>
</div>

<hr>

<!-- Training Engine Section -->
<div class="card">
    <h3>Training Engine</h3>

    <div class="form-group">
        <label for="engine">Engine</label>
        <select id="engine" name="engine_name">
            <option value="UnSloth (LoRA)" selected>UnSloth (LoRA)</option>
            <option value="Transformers (LoRA)">Transformers (LoRA)</option>
        </select>
    </div>

    <div class="form-group">
        <label for="precision">Precision</label>
        <select id="precision" name="precision">
            <option value="4-bit" selected>4-bit (recommended default)</option>
            <option value="8-bit">8-bit (balanced)</option>
            <option value="16-bit">16-bit (best quality, high VRAM)</option>
        </select>
        <div class="info-text">16-bit trains best; switch to 4-bit/8-bit if VRAM is tight.</div>
    </div>

    <h4>Generation Settings</h4>
    <div style="display: flex; gap: 16px;">
        <div class="form-group" style="flex: 1;">
            <label for="temperature">Temperature</label>
            <input type="number"
                   id="temperature"
                   name="temperature"
                   value="1.2"
                   min="0.1"
                   max="2.0"
                   step="0.1">
            <div class="info-text">Higher = more creative/random</div>
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="max-new-tokens">Max New Tokens</label>
            <input type="number"
                   id="max-new-tokens"
                   name="max_new_tokens"
                   value="256"
                   min="64"
                   max="4096"
                   step="64">
            <div class="info-text">Maximum length of generated responses</div>
        </div>
    </div>

    <h4>Training Settings</h4>
    <div style="display: flex; gap: 16px;">
        <div class="form-group" style="flex: 1;">
            <label for="learning-rate">Learning Rate</label>
            <input type="text"
                   id="learning-rate"
                   name="learning_rate"
                   value="2e-5"
                   placeholder="2e-5">
            <div class="info-text">How fast the model learns. Default is conservative</div>
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="kl-beta">KL Beta</label>
            <input type="number"
                   id="kl-beta"
                   name="kl_beta"
                   value="0.03"
                   min="0"
                   max="1"
                   step="0.01">
            <div class="info-text">Anchor strength. Higher = stays closer to base model</div>
        </div>
    </div>

    <h4>LoRA Settings</h4>
    <p><em>LoRA trains small adapter layers instead of the full model, reducing memory usage.</em></p>
    <div style="display: flex; gap: 16px;">
        <div class="form-group" style="flex: 1;">
            <label for="lora-rank">Rank</label>
            <input type="number"
                   id="lora-rank"
                   name="lora_rank"
                   value="16"
                   min="8"
                   max="128"
                   step="8">
            <div class="info-text">Adapter capacity. Higher = more expressive</div>
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="lora-alpha">Alpha</label>
            <input type="number"
                   id="lora-alpha"
                   name="lora_alpha"
                   value="16"
                   min="8"
                   max="128"
                   step="8">
            <div class="info-text">Scaling factor. Usually set equal to rank</div>
        </div>
    </div>
</div>

<hr>

<!-- Undo & Checkpoints Section -->
<div class="card">
    <h3>Undo & Checkpoints</h3>
    <p><em>Trellis saves checkpoints after each step, allowing you to undo mistakes.</em></p>

    <div class="form-group">
        <label for="max-undos">Max Checkpoints to Keep</label>
        <input type="number"
               id="max-undos"
               name="max_undos"
               placeholder="Leave blank for unlimited"
               min="1">
        <div class="info-text">Leave blank for unlimited (recommended for short sessions)</div>
    </div>

    <div class="form-group">
        <label for="checkpoint-interval">Checkpoint Every N Steps</label>
        <input type="number"
               id="checkpoint-interval"
               name="checkpoint_interval"
               value="1"
               min="1">
        <div class="info-text">Save a checkpoint every N steps to reduce disk usage.</div>
    </div>
    <p><em>Each checkpoint uses ~500MB for an 8B model. Unlimited checkpoints recommended for sessions under 50 steps.</em></p>
</div>

<hr>

<!-- Validation Section -->
<div class="card">
    <h3>Validation & Monitoring</h3>
    <p><em>Track model behavior on a specific prompt throughout training.</em></p>

    <div class="form-group">
        <label for="control-prompt">Control Prompt (optional)</label>
        <textarea id="control-prompt"
                  name="control_prompt"
                  rows="2"
                  placeholder="e.g., 'Explain the concept of love.' or 'Who are you?'"></textarea>
        <div class="info-text">The model will generate a response to this prompt after every training step, allowing you to monitor drift or behavioral changes.</div>
    </div>
</div>

<hr>

<!-- System Prompt Section -->
<div class="card">
    <h3>System Prompt & Wrapping</h3>
    <p><em>Customize how prompts are formatted before being sent to the model. Most users can leave these blank.</em></p>

    <div class="form-group">
        <label for="system-prompt">System Prompt (optional)</label>
        <textarea id="system-prompt"
                    name="system_prompt"
                    rows="3"
                    placeholder="Custom system prompt for the model..."></textarea>
        <div class="info-text">Sets the model's role or persona</div>
    </div>

    <div style="display: flex; gap: 16px;">
        <div class="form-group" style="flex: 1;">
            <label for="prompt-prefix">Prompt Prefix</label>
            <input type="text"
                    id="prompt-prefix"
                    name="prompt_prefix"
                    placeholder="Added before each prompt">
        </div>
        <div class="form-group" style="flex: 1;">
            <label for="prompt-suffix">Prompt Suffix</label>
            <input type="text"
                    id="prompt-suffix"
                    name="prompt_suffix"
                    placeholder="Added after each prompt">
        </div>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox"
                    id="append-think-tag"
                    name="append_think_tag"
                    >
            Append &lt;think&gt; to assistant prompt
        </label>
        <div class="info-text">Enable to automatically prepend &lt;think&gt; so responses start with a reasoning tag.</div>
    </div>
</div>

<hr>

<!-- Go Button -->
<div style="text-align: center; margin-top: 24px;">
    <button class="primary"
            style="font-size: 16px; padding: 12px 32px;"
            onclick="startTrainingSession()">
        Go! Start Training
    </button>
</div>

<div id="go-status" style="margin-top: 16px; text-align: center;"></div>

<script>
function startTrainingSession() {
    // Save to local storage first
    saveConfig();

    // Collect all form values
    const formData = new URLSearchParams();
    formData.append('model_name', document.getElementById('model-name').value);
    formData.append('context_length', document.getElementById('context-length').value);
    formData.append('group_size', document.getElementById('group-size').value);
    formData.append('engine_name', document.getElementById('engine').value);
    formData.append('learning_rate', parseFloat(document.getElementById('learning-rate').value));
    formData.append('kl_beta', document.getElementById('kl-beta').value);
    formData.append('temperature', document.getElementById('temperature').value);
    formData.append('max_new_tokens', document.getElementById('max-new-tokens').value);
    formData.append('lora_rank', document.getElementById('lora-rank').value);
    formData.append('lora_alpha', document.getElementById('lora-alpha').value);
    formData.append('max_undos', document.getElementById('max-undos').value || '');
    formData.append('system_prompt', document.getElementById('system-prompt').value || '');
    formData.append('prompt_prefix', document.getElementById('prompt-prefix').value || '');
    formData.append('prompt_suffix', document.getElementById('prompt-suffix').value || '');
    formData.append('dataset_id', document.getElementById('dataset-id').value);
    formData.append('dataset_subset', document.getElementById('dataset-subset').value || '');
    formData.append('dataset_split', document.getElementById('dataset-split').value);
    formData.append('dataset_column', document.getElementById('dataset-column').value || '');
    formData.append('precision', document.getElementById('precision').value);
    formData.append('append_think_tag', document.getElementById('append-think-tag').checked);
    formData.append('use_chat_template', document.getElementById('use-chat-template').checked);
    formData.append('checkpoint_interval', document.getElementById('checkpoint-interval').value);
    formData.append('control_prompt', document.getElementById('control-prompt').value || '');

    const statusDiv = document.getElementById('go-status');
    statusDiv.innerHTML = '<p><em>Starting training session...</em></p>';

    // Use fetch to POST, then connect SSE
    fetch('/setup/start-training', {
        method: 'POST',
        body: formData,
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to start training session');
        }

        // Connect to SSE stream using response body
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    return;
                }

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6);
                        try {
                            const parsed = JSON.parse(data);
                            statusDiv.innerHTML += '<p>' + parsed + '</p>';
                        } catch {
                            statusDiv.innerHTML += '<p>' + data + '</p>';
                        }
                    } else if (line.includes('event: redirect')) {
                        // Wait for next line with data
                        setTimeout(() => {
                            window.location.href = '/training';
                        }, 500);
                    }
                });

                readStream();
            });
        }

        readStream();
    })
    .catch(error => {
        statusDiv.innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
    });
}

// ========== LocalStorage Persistence ==========

function saveConfig() {
    const config = {
        model_name: document.getElementById('model-name').value,
        context_length: document.getElementById('context-length').value,
        group_size: document.getElementById('group-size').value,
        learning_rate: document.getElementById('learning-rate').value,
        kl_beta: document.getElementById('kl-beta').value,
        temperature: document.getElementById('temperature').value,
        max_new_tokens: document.getElementById('max-new-tokens').value,
        lora_rank: document.getElementById('lora-rank').value,
        lora_alpha: document.getElementById('lora-alpha').value,
        max_undos: document.getElementById('max-undos').value,
        checkpoint_interval: document.getElementById('checkpoint-interval').value,
        system_prompt: document.getElementById('system-prompt').value,
        prompt_prefix: document.getElementById('prompt-prefix').value,
        prompt_suffix: document.getElementById('prompt-suffix').value,
        dataset_id: document.getElementById('dataset-id').value,
        dataset_subset: document.getElementById('dataset-subset').value,
        dataset_split: document.getElementById('dataset-split').value,
        dataset_column: document.getElementById('dataset-column').value,
        control_prompt: document.getElementById('control-prompt').value,
        precision: document.getElementById('precision').value,
        engine: document.getElementById('engine').value,
        append_think_tag: document.getElementById('append-think-tag').checked,
        use_chat_template: document.getElementById('use-chat-template').checked
    };
    localStorage.setItem('trellis_setup_config', JSON.stringify(config));
}

function restoreConfig() {
    const saved = localStorage.getItem('trellis_setup_config');
    if (!saved) return;

    try {
        const config = JSON.parse(saved);
        
        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if (el && val !== undefined) el.value = val;
        };
        const setCheck = (id, val) => {
            const el = document.getElementById(id);
            if (el && val !== undefined) el.checked = val;
        };

        setVal('model-name', config.model_name);
        setVal('context-length', config.context_length);
        setVal('group-size', config.group_size);
        setVal('learning-rate', config.learning_rate);
        setVal('kl-beta', config.kl_beta);
        setVal('temperature', config.temperature);
        setVal('max-new-tokens', config.max_new_tokens);
        setVal('lora-rank', config.lora_rank);
        setVal('lora-alpha', config.lora_alpha);
        setVal('max-undos', config.max_undos);
        setVal('checkpoint-interval', config.checkpoint_interval);
        setVal('system-prompt', config.system_prompt);
        setVal('prompt-prefix', config.prompt_prefix);
        setVal('prompt-suffix', config.prompt_suffix);
        setVal('dataset-id', config.dataset_id);
        setVal('dataset-subset', config.dataset_subset);
        setVal('dataset-split', config.dataset_split);
        setVal('dataset-column', config.dataset_column);
        setVal('control-prompt', config.control_prompt);
        setVal('precision', config.precision);
        setVal('engine', config.engine);
        
        setCheck('append-think-tag', config.append_think_tag);
        setCheck('use-chat-template', config.use_chat_template);
        
    } catch (e) {
        console.error("Failed to restore config", e);
    }
}

// Auto-restore on load
document.addEventListener('DOMContentLoaded', restoreConfig);
</script>

{% endblock %}
